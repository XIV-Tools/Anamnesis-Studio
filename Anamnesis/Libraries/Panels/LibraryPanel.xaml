<panels:PanelBase
	x:Class="Anamnesis.Libraries.Panels.LibraryPanel"
	xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
	xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
	xmlns:XivToolsWpf="clr-namespace:XivToolsWpf.Controls;assembly=XivToolsWpf"
	xmlns:ana="clr-namespace:Anamnesis"
	xmlns:controls="clr-namespace:Anamnesis.Controls"
	xmlns:controls1="clr-namespace:Anamnesis.Libraries.Controls"
	xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
	xmlns:libraryItems="clr-namespace:Anamnesis.Libraries.Items"
	xmlns:local="clr-namespace:Anamnesis.Libraries.Panels"
	xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
	xmlns:panels="clr-namespace:Anamnesis.Panels"
	xmlns:vwp="clr-namespace:WpfToolkit.Controls;assembly=VirtualizingWrapPanel"
	Width="800"
	Height="450"
	CanResize="True"
	Icon="Book"
	TitleKey="Naviagation_Library"
	mc:Ignorable="d">

	<Grid x:Name="ContentArea">
		<Grid.ColumnDefinitions>
			<ColumnDefinition Width="Auto" />
			<ColumnDefinition Width="250" />
			<ColumnDefinition />
		</Grid.ColumnDefinitions>

		<!--  packs  -->
		<Grid
			Grid.Column="0"
			Width="200">

			<Grid.LayoutTransform>
				<ScaleTransform />
			</Grid.LayoutTransform>

			<Grid.Style>

				<Style TargetType="{x:Type Grid}">
					<Style.Triggers>
						<DataTrigger
							Binding="{Binding NarrowMode}"
							Value="True">

							<DataTrigger.EnterActions>
								<StopStoryboard BeginStoryboardName="CloseStoryboard" />
								<BeginStoryboard
									x:Name="OpenStoryboard"
									Storyboard="{StaticResource Expand_ScaleX}" />
							</DataTrigger.EnterActions>
							<DataTrigger.ExitActions>
								<StopStoryboard BeginStoryboardName="OpenStoryboard" />
								<BeginStoryboard
									x:Name="CloseStoryboard"
									Storyboard="{StaticResource Collapse_ScaleX}" />
							</DataTrigger.ExitActions>

						</DataTrigger>
					</Style.Triggers>
				</Style>
			</Grid.Style>

			<ListBox
				ItemsSource="{Binding Services.Library.Packs}"
				SelectedItem="{Binding SelectedPack}"
				SelectionChanged="OnPackSelectionChanged">

				<ListBox.ItemContainerStyle>
					<Style TargetType="{x:Type ListBoxItem}">

						<Setter Property="Template">
							<Setter.Value>
								<ControlTemplate TargetType="{x:Type ListBoxItem}">
									<ToggleButton
										HorizontalContentAlignment="Stretch"
										IsChecked="{Binding RelativeSource={RelativeSource Mode=FindAncestor, AncestorType={x:Type ListBoxItem}}, Path=IsSelected}"
										Style="{StaticResource TransparentIconToggleButton}">

										<controls1:PackItem Margin="0,6" />

									</ToggleButton>
								</ControlTemplate>
							</Setter.Value>
						</Setter>
					</Style>
				</ListBox.ItemContainerStyle>
			</ListBox>
		</Grid>

		<!--  Sidebar  -->
		<Grid
			Grid.Column="1"
			Visibility="{Binding SelectedPack, Converter={StaticResource NotNullToVisibilityConverter}}">
			<Grid.RowDefinitions>
				<RowDefinition Height="Auto" />
				<RowDefinition Height="Auto" />
				<RowDefinition />
				<RowDefinition Height="Auto" />
				<RowDefinition Height="Auto" />
			</Grid.RowDefinitions>

			<ComboBox
				Grid.Row="0"
				Margin="6"
				ItemsSource="{Binding Services.Library.Packs}"
				SelectedItem="{Binding SelectedPack}"
				Visibility="{Binding NarrowMode, Converter={StaticResource B2V}}">
				<ComboBox.ItemTemplate>
					<DataTemplate>
						<controls1:PackItem />
					</DataTemplate>
				</ComboBox.ItemTemplate>
			</ComboBox>

			<!--  Pack Info  -->
			<Border
				Grid.Row="1"
				Grid.Column="1"
				Margin="6,1,1,1"
				Style="{StaticResource InsetPanel}"
				Visibility="{Binding SelectedItem, Converter={StaticResource NullToVisibilityConverter}}">

				<Grid
					Margin="6"
					VerticalAlignment="Top">

					<Grid.RowDefinitions>
						<RowDefinition Height="Auto" />
						<RowDefinition Height="Auto" />
						<RowDefinition Height="Auto" />
						<RowDefinition Height="Auto" />
						<RowDefinition Height="Auto" />
						<RowDefinition Height="Auto" />
						<RowDefinition Height="Auto" />
						<RowDefinition Height="Auto" />
					</Grid.RowDefinitions>

					<Grid.ColumnDefinitions>
						<ColumnDefinition Width="Auto" />
						<ColumnDefinition />
					</Grid.ColumnDefinitions>

					<controls:Image
						Grid.Row="0"
						Grid.ColumnSpan="2"
						Height="138"
						Margin="-8,-8,-8,0"
						BorderBrush="Transparent"
						BorderThickness="1"
						CornerRadius="6,6,0,0"
						Source="{Binding SelectedPack.HeaderImage}" />

					<XivToolsWpf:TextBlock
						Grid.Row="1"
						Grid.ColumnSpan="3"
						Margin="0,6,0,0"
						Style="{StaticResource Header}"
						Text="{Binding SelectedPack.Name}" />

					<XivToolsWpf:TextBlock
						Grid.Row="2"
						Grid.ColumnSpan="2"
						Margin="10,0,0,12"
						Text="{Binding SelectedPack.Description}"
						TextWrapping="Wrap"
						Visibility="{Binding SelectedPack.Description, Converter={StaticResource NotNullToVisibilityConverter}}" />


					<XivToolsWpf:TextBlock
						Key="FileMeta_Author"
						Grid.Row="3"
						Grid.Column="0"
						Margin="0,0,6,0"
						Style="{StaticResource Label}" />
					<XivToolsWpf:TextBlock
						Grid.Row="3"
						Grid.Column="1"
						Text="{Binding SelectedPack.Author}" />

					<XivToolsWpf:TextBlock
						Key="FileMeta_Version"
						Grid.Row="4"
						Grid.Column="0"
						Margin="0,0,6,0"
						Style="{StaticResource Label}"
						Visibility="{Binding SelectedPack.Version, Converter={StaticResource NotNullToVisibilityConverter}}" />
					<XivToolsWpf:TextBlock
						Grid.Row="4"
						Grid.Column="1"
						Text="{Binding SelectedPack.Version}"
						Visibility="{Binding SelectedPack.Version, Converter={StaticResource NotNullToVisibilityConverter}}" />

					<XivToolsWpf:TextBlock
						Key="Library_Source"
						Grid.Row="5"
						Grid.Column="0"
						Margin="0,0,6,0"
						Style="{StaticResource Label}" />

					<Grid
						Grid.Row="5"
						Grid.Column="1">

						<Grid.ColumnDefinitions>
							<ColumnDefinition Width="Auto" />
							<ColumnDefinition />
						</Grid.ColumnDefinitions>

						<XivToolsWpf:IconBlock
							Grid.Column="0"
							Margin="0,0,3,0"
							Icon="{Binding SelectedPack.Source.Icon}" />
						<XivToolsWpf:TextBlock
							Grid.Column="1"
							Text="{Binding SelectedPack.Source.Name}"
							TextTrimming="CharacterEllipsis" />
					</Grid>

					<XivToolsWpf:TextBlock
						Key="Library_Items"
						Grid.Row="6"
						Grid.Column="0"
						Margin="0,0,6,0"
						Style="{StaticResource Label}" />

					<XivToolsWpf:TextBlock
						Grid.Row="6"
						Grid.Column="1"
						Margin="0,0,6,0"
						Text="{Binding SelectedPack.ItemCount, StringFormat='{}{0:n0}'}" />

					<Grid
						Grid.Row="7"
						Grid.ColumnSpan="2"
						Margin="0,6,0,0">

						<Button
							Width="28"
							Height="28"
							HorizontalAlignment="Left"
							Click="OnPackRefreshClicked"
							Style="{StaticResource TransparentIconButton}">
							<XivToolsWpf:IconBlock Icon="Refresh" />
						</Button>

						<Button
							Height="26"
							Margin="3,0,0,0"
							HorizontalAlignment="Right"
							Click="OnPackUpdateClicked"
							IsEnabled="{Binding SelectedPack.IsUpdating, Converter={StaticResource !B}}"
							Style="{StaticResource TransparentButton}"
							Visibility="{Binding SelectedPack.IsUpdateAvailable, Converter={StaticResource B2V}}">

							<Grid>
								<Grid
									Margin="6,0"
									Visibility="{Binding SelectedPack.IsUpdating, Converter={StaticResource !B2V}}">
									<Grid.ColumnDefinitions>
										<ColumnDefinition Width="Auto" />
										<ColumnDefinition />
									</Grid.ColumnDefinitions>

									<XivToolsWpf:IconBlock
										Grid.Column="0"
										Margin="3"
										Icon="Download" />
									<XivToolsWpf:TextBlock
										Grid.Column="1"
										Margin="3"
										Text="Update Available" />
								</Grid>

								<Grid
									Margin="6,0"
									Visibility="{Binding SelectedPack.IsUpdating, Converter={StaticResource B2V}}">
									<Grid.ColumnDefinitions>
										<ColumnDefinition Width="Auto" />
										<ColumnDefinition />
									</Grid.ColumnDefinitions>

									<ProgressBar
										Grid.Column="0"
										IsIndeterminate="True"
										Style="{StaticResource MaterialDesignCircularProgressBar}" />

									<XivToolsWpf:TextBlock
										Grid.Column="1"
										Margin="3"
										Text="Updating" />
								</Grid>
							</Grid>

						</Button>
					</Grid>

				</Grid>
			</Border>

			<!--  Item Info  -->
			<Border
				Grid.Row="1"
				Grid.Column="1"
				Margin="1"
				Style="{StaticResource InsetPanel}"
				Visibility="{Binding SelectedItem, Converter={StaticResource NotNullToVisibilityConverter}}">

				<Grid
					Margin="6"
					VerticalAlignment="Top">

					<Grid.RowDefinitions>
						<RowDefinition Height="Auto" />
						<RowDefinition Height="Auto" />
						<RowDefinition Height="Auto" />
						<RowDefinition Height="Auto" />
						<RowDefinition Height="Auto" />
					</Grid.RowDefinitions>

					<Grid.ColumnDefinitions>
						<ColumnDefinition Width="Auto" />
						<ColumnDefinition />
					</Grid.ColumnDefinitions>

					<controls:Image
						Grid.Row="0"
						Grid.ColumnSpan="2"
						Height="250"
						Margin="-8,-8,-8,0"
						BorderBrush="Transparent"
						BorderThickness="1"
						CornerRadius="6,6,0,0"
						Source="{Binding SelectedItem.Thumbnail}" />

					<XivToolsWpf:TextBlock
						Grid.Row="1"
						Grid.ColumnSpan="3"
						Margin="0,6,0,0"
						Style="{StaticResource Header}"
						Text="{Binding SelectedItem.Name}" />

					<XivToolsWpf:TextBlock
						Grid.Row="2"
						Grid.ColumnSpan="2"
						Margin="10,0,0,12"
						Text="{Binding SelectedItem.Description}"
						TextWrapping="Wrap"
						Visibility="{Binding SelectedItem.Description, Converter={StaticResource NotEmptyToVisibilityConverter}}" />


					<XivToolsWpf:TextBlock
						Key="FileMeta_Author"
						Grid.Row="3"
						Grid.Column="0"
						Margin="0,0,6,0"
						Style="{StaticResource Label}"
						Visibility="{Binding SelectedItem.Author, Converter={StaticResource NotEmptyToVisibilityConverter}}" />
					<XivToolsWpf:TextBlock
						Grid.Row="3"
						Grid.Column="1"
						Text="{Binding SelectedItem.Author}"
						Visibility="{Binding SelectedItem.Author, Converter={StaticResource NotEmptyToVisibilityConverter}}" />

					<XivToolsWpf:TextBlock
						Key="FileMeta_Version"
						Grid.Row="4"
						Grid.Column="0"
						Margin="0,0,6,0"
						Style="{StaticResource Label}"
						Visibility="{Binding SelectedItem.Version, Converter={StaticResource NotEmptyToVisibilityConverter}}" />
					<XivToolsWpf:TextBlock
						Grid.Row="4"
						Grid.Column="1"
						Text="{Binding SelectedItem.Version}"
						Visibility="{Binding SelectedItem.Version, Converter={StaticResource NotEmptyToVisibilityConverter}}" />
				</Grid>
			</Border>

			<ScrollViewer Grid.Row="2">
				<Grid>

					<Grid.RowDefinitions>
						<RowDefinition Height="Auto" />
						<RowDefinition Height="Auto" />
						<RowDefinition />
					</Grid.RowDefinitions>

					<ItemsControl
						Grid.Row="1"
						ItemsSource="{Binding FilterByTags}">
						<ItemsControl.ItemsPanel>
							<ItemsPanelTemplate>
								<WrapPanel />
							</ItemsPanelTemplate>
						</ItemsControl.ItemsPanel>
						<ItemsControl.ItemTemplate>
							<DataTemplate>
								<ToggleButton
									Margin="3"
									IsChecked="{Binding IsEnabled}"
									IsEnabled="{Binding IsAvailable}">
									<ToggleButton.Style>
										<Style TargetType="{x:Type ToggleButton}">
											<Setter Property="Foreground" Value="{StaticResource MaterialDesignBody}" />

											<Setter Property="Template">
												<Setter.Value>
													<ControlTemplate TargetType="{x:Type ToggleButton}">
														<Grid>
															<Border
																x:Name="Border"
																Background="{StaticResource MaterialDesignPaper}"
																CornerRadius="10" />

															<Grid
																x:Name="ContentGrid"
																Margin="3,-2">
																<Grid.ColumnDefinitions>
																	<ColumnDefinition Width="Auto" />
																	<ColumnDefinition />
																</Grid.ColumnDefinitions>

																<XivToolsWpf:IconBlock
																	x:Name="TagIcon"
																	Grid.Column="0"
																	Margin="2,2,2,0"
																	Foreground="{StaticResource MaterialDesignBodyLight}"
																	Icon="Tag"
																	Opacity="0.5" />

																<ContentPresenter
																	Grid.Column="1"
																	Content="{TemplateBinding Content}" />

															</Grid>
														</Grid>

														<ControlTemplate.Triggers>
															<Trigger Property="IsChecked" Value="False">
																<Setter TargetName="TagIcon" Property="Foreground" Value="{StaticResource MaterialDesignBody}" />
																<Setter TargetName="ContentGrid" Property="Opacity" Value="0.5" />
																<Setter TargetName="Border" Property="Background" Value="Black" />
																<Setter TargetName="Border" Property="Opacity" Value="0.25" />
															</Trigger>
															<Trigger Property="IsEnabled" Value="False">
																<Setter TargetName="TagIcon" Property="Foreground" Value="{StaticResource MaterialDesignTextFieldBoxDisabledBackground}" />
																<Setter Property="Foreground" Value="{StaticResource MaterialDesignTextFieldBoxDisabledBackground}" />
																<Setter TargetName="Border" Property="Opacity" Value="0" />
															</Trigger>
														</ControlTemplate.Triggers>
													</ControlTemplate>
												</Setter.Value>
											</Setter>
										</Style>
									</ToggleButton.Style>

									<XivToolsWpf:TextBlock
										MaxWidth="100"
										Margin="4"
										Text="{Binding Name}"
										TextTrimming="CharacterEllipsis" />
								</ToggleButton>
							</DataTemplate>
						</ItemsControl.ItemTemplate>
					</ItemsControl>
				</Grid>
			</ScrollViewer>

			<CheckBox
				Grid.Row="3"
				Margin="6,3,6,6">
				<TextBlock Text="Live Preview" />
			</CheckBox>
		</Grid>



		<Grid
			Grid.Column="2"
			Visibility="{Binding SelectedPack, Converter={StaticResource NotNullToVisibilityConverter}}">
			<Grid.RowDefinitions>
				<RowDefinition Height="Auto" />
				<RowDefinition />
				<RowDefinition Height="Auto" />
			</Grid.RowDefinitions>

			<!--  Toolbar  -->
			<Grid Grid.Row="0">

				<Grid.ColumnDefinitions>
					<ColumnDefinition Width="Auto" />
					<ColumnDefinition />
					<ColumnDefinition Width="200" />
					<ColumnDefinition Width="Auto" />
				</Grid.ColumnDefinitions>

				<Button
					Margin="6,3,0,3"
					Click="OnBackClicked"
					IsEnabled="{Binding CurrentDirectory, Converter={StaticResource NotNullToBoolConverter}}"
					Style="{StaticResource TransparentIconButton}">
					<StackPanel Orientation="Horizontal">
						<XivToolsWpf:IconBlock Icon="ChevronLeft" />
						<XivToolsWpf:TextBlock
							Margin="6,0,6,0"
							Text="Back" />
					</StackPanel>
				</Button>

				<Border
					Grid.Column="2"
					Margin="3,3,6,3"
					Background="#33000000"
					CornerRadius="6">
					<Grid>
						<XivToolsWpf:IconBlock
							Margin="6,0,6,1"
							HorizontalAlignment="Left"
							VerticalAlignment="Center"
							FontSize="12"
							Icon="Search"
							Visibility="{Binding Search, Converter={StaticResource IsEmptyToVisibilityConverter}}" />

						<TextBox
							x:Name="SearchBox"
							Margin="4,0,4,2"
							Padding="12,0,0,0"
							VerticalContentAlignment="Center"
							BorderThickness="0"
							Style="{StaticResource MaterialDesignTextBox}"
							Text="{Binding Search, UpdateSourceTrigger=PropertyChanged}" />

						<Button
							Width="24"
							Padding="0"
							HorizontalAlignment="Left"
							Click="OnClearSearchClicked"
							Style="{StaticResource TransparentIconButton}"
							Visibility="{Binding Search, Converter={StaticResource NotEmptyToVisibilityConverter}}">
							<XivToolsWpf:IconBlock
								Margin="6,0,6,1"
								HorizontalAlignment="Left"
								VerticalAlignment="Center"
								FontSize="12"
								Icon="Times" />
						</Button>

					</Grid>

				</Border>

				<Border
					Grid.Column="3"
					Width="64"
					Height="28"
					Margin="3,3,6,3"
					HorizontalAlignment="Right"
					Background="#33000000"
					CornerRadius="6">

					<Grid>
						<Grid.ColumnDefinitions>
							<ColumnDefinition />
							<ColumnDefinition />
						</Grid.ColumnDefinitions>

						<RadioButton
							Grid.Column="0"
							IsChecked="{Binding ViewList, Converter={StaticResource !B}}"
							Style="{StaticResource TransparentIconToggleButton}">
							<XivToolsWpf:IconBlock Icon="BorderAll" />
						</RadioButton>

						<RadioButton
							Grid.Column="1"
							IsChecked="{Binding ViewList}"
							Style="{StaticResource TransparentIconToggleButton}">
							<XivToolsWpf:IconBlock Icon="List" />
						</RadioButton>
					</Grid>
				</Border>
			</Grid>

			<!--  Icon Grid  -->
			<ListBox
				Grid.Row="1"
				ana:Behaviours.SmoothScroll="True"
				Background="Transparent"
				ItemsSource="{Binding Entries, IsAsync=True}"
				MouseDoubleClick="OnItemDoubleClicked"
				SelectedItem="{Binding SelectedEntry}"
				VirtualizingPanel.ScrollUnit="Pixel"
				VirtualizingPanel.VirtualizationMode="Recycling"
				Visibility="{Binding ViewList, Converter={StaticResource !B2V}}">

				<ListBox.ItemsPanel>
					<ItemsPanelTemplate>
						<vwp:VirtualizingWrapPanel IsItemsHost="True" />
					</ItemsPanelTemplate>
				</ListBox.ItemsPanel>

				<ListBox.ItemTemplate>
					<DataTemplate>

						<Grid
							Width="92"
							Height="128">

							<Grid.RowDefinitions>
								<RowDefinition Height="96" />
								<RowDefinition Height="32" />
							</Grid.RowDefinitions>

							<controls1:EntryIcon />

							<XivToolsWpf:TextBlock
								Grid.Row="1"
								VerticalAlignment="Top"
								Text="{Binding Name}"
								TextAlignment="Center"
								TextWrapping="Wrap" />
						</Grid>


					</DataTemplate>
				</ListBox.ItemTemplate>
			</ListBox>

			<!--  List  -->
			<ListBox
				Grid.Row="1"
				Background="Transparent"
				ItemsSource="{Binding Entries, IsAsync=True}"
				MouseDoubleClick="OnItemDoubleClicked"
				SelectedItem="{Binding SelectedEntry}"
				Visibility="{Binding ViewList, Converter={StaticResource B2V}}">

				<ListBox.ItemTemplate>
					<DataTemplate>
						<Grid>

							<Grid.ColumnDefinitions>
								<ColumnDefinition Width="Auto" />
								<ColumnDefinition />
							</Grid.ColumnDefinitions>

							<controls1:EntryIcon
								Width="48"
								Height="48"
								Margin="0,-6,0,-4" />

							<XivToolsWpf:TextBlock
								Grid.Column="1"
								Margin="12,0,0,0"
								VerticalAlignment="Center"
								Text="{Binding Name}"
								TextTrimming="CharacterEllipsis" />
						</Grid>
					</DataTemplate>
				</ListBox.ItemTemplate>
			</ListBox>

			<XivToolsWpf:TextBlock
				Key="Library_ItemCount"
				Grid.Row="2"
				Margin="3,3,20,3"
				HorizontalAlignment="Right"
				Style="{StaticResource Label}"
				Value="{Binding Entries.Count}" />
		</Grid>
	</Grid>
</panels:PanelBase>
